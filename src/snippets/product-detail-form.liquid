{%- comment %}

  Product Detail Form Snippet
  ------------------------------------------------------------------------------

  Usage:

  {% include 'product-detail-form',
              product: { product } - required
              current_variant: { variant} - optional
  %}

{% endcomment -%}

{%- capture shipping_modal_html -%}
  {% include 'shipping-modal' %}
{%- endcapture -%}

{% if template.name == 'product' and template.suffix == 'quick-view' %}
  {% assign is_quick_view = true %}
{% endif %}

{% if current_variant == blank %}
  {% assign current_variant = product.selected_or_first_available_variant %}
{% endif %}

{% capture tag_text %}
{% if product.available %}
  {% if current_variant.metafields.custom_fields['badge'] != blank %}
    {{ current_variant.metafields.custom_fields['badge'] }}
  {% elsif product.metafields.custom_fields['badge'] != blank %}
    {{ product.metafields.custom_fields['badge'] }}
  {% else %}
    {% for tag in product.tags %}
      {% if tag contains 'Badge:' or tag contains 'badge:'%}
        {{ tag | remove: 'Badge:' | remove: 'badge:' }}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% else %}
  SOLD OUT
{% endif %}
{% endcapture %}

{% capture klarna_snippet %}
  <!-- Placement v2 -->
    <klarna-placement
      class="klarna-messaging"
      data-key="credit-promotion-small"
      data-locale="en-US"
      data-purchase-amount="{{ product.selected_or_first_available_variant.price }}"
    ></klarna-placement>
  <!-- end Placement -->
{% endcapture %}

<div class="product__form {% if product.type == 'Gift Card' %}product__form--gift-card{% endif %}" data-product-detail-form>
  <div class="product__badge-row">
    <span class="badge" data-badge {% unless tag_text != blank %} style="display:none;" {% endunless %}>
      {{ tag_text }}
    </span>
  </div>

  <h1 class="h5 product__title">{{ product.title }}</h1>

  {% if settings.display_reviews == true  and product.type != 'Gift Card' %}
    {% include 'rating-stars' %}
  {% endif %}
  {% unless product.type == 'Gift Card' or enable_bundles == true %}
    <div class="product__price">
      {% include 'product-detail-price', product: product, current_variant: current_variant %}
    </div>
  {% endunless %}
  {% if section.settings.enable_klarna == true %}
    {% unless enable_bundles == true or product.type == 'Gift Card' or product.tags contains 'klarna-hide' %}
      {{ klarna_snippet }}
    {% endunless %}
  {% endif %}


  {% include 'product-upsell', pum_product: product %}


  <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
    <meta itemprop="priceCurrency" content="{{ shop.currency }}">
    <meta itemprop="price" content="{{ current_variant.price | divided_by: 100.00 }}">
    <link itemprop="availability" href="http://schema.org/{% if current_variant.available %}InStock{% else %}OutOfStock{% endif %}">

    <div data-add-to-cart-form-wrapper>
      <form action="/cart/add" method="post" enctype="multipart/form-data" data-add-to-cart-form>
        {% if enable_bundles == true %}
          <div class="bundle-options selector-wrapper">
            <span class="product__selector-header"> {{ section.settings.bundle_quantity_title }}</span>
            <div class="bundle__options-container bundle__options-container--disabled" data-bundle-options-container>
              {% for i in product.metafields.custom_fields["bundle_options"] %}
                <label class="bundle__option-container">
                  <input type="radio" name="bundleOption" {% if forloop.index == 1 %} checked{% endif %} style="display:none;" value="{{i.quantity}}" data-bundle-quantity-option data-bundle-discount="{{i.discount_value}}">
                  <div class="bundle__option">
                    <span class="bundle__option-description">
                      {{ i.quantity }} {{ i.unit_descriptor }}
                    </span>

                    {% if i.quantity == 1 %}
                      <div class="bundle__price">

                        <span class="bundle__full-price" data-product-price>{{current_variant.price | money_without_trailing_zeros }}</span>
                      </div>
                    {% else %}
                      <span class="bundle__discount">
                        {{i.discount_value}}% off
                      </span>
                    {% endif %}
                  </div>
                </label>
              {% endfor %}
            </div>
          </div>
          {% if section.settings.enable_klarna == true %}
          {% unless product.type == 'Gift Card' or product.tags contains 'klarna-hide' %}
              {{ klarna_snippet }}
            {% endunless %}
          {% endif %}
        {% endif %}

        {% if enable_bundles == true %}
          <div class="bundle-products selector-wrapper" data-bundle-products-container>
            {%- comment -%}Get the largest amount of items out of the metafield options{%- endcomment -%}
            {% assign max_items = 0 %}
            {% for i in product.metafields.custom_fields["bundle_options"] %}
              {% if i.quantity > max_items %}
                {% assign max_items = i.quantity %}
              {% endif %}
            {% endfor %}
            <span class="product__selector-header">{{ section.settings.bundle_product_title }}</span>
            <div class="bundle-products__container">
              {% for i in (1..max_items) %}
              <label class="bundle-product__wrapper" data-bundle-product-item>
                <input type="hidden" name="bundle-product-id" data-bundle-product-id value="{{current_variant.id}}">
                <input type="radio" name="current_bundle" value="{{forloop.index}}" data-bundle-product style="display:none;">
                <div class="bundle-product__container">
                  <div class="bundle-product__image">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="
                        data-src="{{ current_variant.featured_image | img_url: '70x' | format: "pjpg" }}"
                        alt="{{current_variant.featured_image.alt }}"
                        data-bundle-product-image
                        class="lazyload">
                  </div>

                  <div class="bundle-product__info">
                    <span class="bundle-product__title">{{ product.title }}</span>
                    {% for option in product.options %}
                      <span class="bundle-product__option">
                        {{ option }}:
                        {% assign option_index = "option" | append:forloop.index %}
                        <span data-option-{{ forloop.index }}> {{current_variant[option_index] }}</span>
                        {% if forloop.last %}
                          <span class="bundle-product__sold-out-badge {% if current_variant.available == false %} is-visible{% endif %}" data-bundle-product-sold-out-badge>Sold Out</span>
                        {% endif %}
                      </span>
                    {% endfor %}
                    <div  class="bundle-product__variant-price">
                      <s data-bundle-current-price class="bundle-product__compare-at-price">{%- if current_variant.compare_at_price > current_variant.price -%} {{current_variant.compare_at_price | money_without_trailing_zeros}} {%- endif -%}</s>
                      <span data-bundle-discount-price data-variant-price="{{current_variant.price}}">{{current_variant.price | money_without_trailing_zeros }}</span>
                    </div>
                  </div>
                </div>
              </label>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        {% unless product.has_only_default_variant %}
          {% for option in product.options_with_values %}

            {% assign base_option_name_downcase = option.name | downcase %}

            {% capture option_alt_ui %}

              {% if base_option_name_downcase == "color" %}
                {% capture collection_product_html %}
                  {% include 'collection-color-dots', product: product %}
                {% endcapture %}

                {% if collection_product_html != blank %}
                  {{ collection_product_html }}
                {% else %}
                  {% include 'product-dots-color', product: product, selected_color: option.selected_value %}
                {% endif %}

              {% endif %}

              {% if base_option_name_downcase == "size" %}
                {% include 'product-dots-sizes', dots_product: product, selected_size: option.selected_value %}

                {% if product.metafields.custom_fields["show_fit_guide"] == 1 or product.metafields.custom_fields["test_fit_guide"] == 1 %}
                  <a href="javascript:void(0);" class="btn-link product__fit-guide-toggler" data-fit-guide-toggler>Fit Guide +</a>
                {% endif %}
              {% endif %}

            {% endcapture %}

            <div class="selector-wrapper form-group js">

              <label class="product__selector-header" for="SingleOptionSelector-{{ forloop.index0 }}">
                {% unless base_option_name_downcase == 'color' %}Select {% endunless %}{{ option.name }}:
                {% if option_alt_ui != blank %}
                  <span class="product__selector-option" data-selected-option-{{option.position}}> {{option.selected_value}} </span>
                {% endif %}
              </label>


              <select
                id="SingleOptionSelector-{{ forloop.index0 }}"
                class="form-control"
                data-single-option-selector
                data-index="option{{ option.position }}"
                {% if option_alt_ui != blank %}style="display: none" data-no-chosen{% endif %}>
                {% for value in option.values %}
                  <option
                    value="{{ value | escape }}"
                    {% if option.selected_value == value %}selected="selected"{% endif %}>
                      {{ value }}
                  </option>
                {% endfor %}
              </select>
              {% if option_alt_ui == blank %}
                {% include 'icon-caret' %}
              {% endif %}

              {% comment %} Output alternative option UI here {% endcomment %}
              {{ option_alt_ui }}
            </div>

            {% comment %}
              To enable alternative variant option value select UI, create your markup here with the following data attributes.

              parent - 'data-option-position="{{ option.position }}" data-variant-option-value-list'
                child - 'data-variant-option-value="{{ value }}"'

              These data attributes are used to attach click events and update the selected variant when one is clicked.
              The child element should respond to some sort of 'active' class to reflect the selected value.

              See: `_scripts/view/product/productDetailForm.js:onVariantOptionValueClick`

              For example, to show a list of sizes..

              {% if option.name == "Size" %}
                <div data-option-position="{{ option.position }}" data-variant-option-value-list>
                  {% for value in option.values %}
                    <span class="{% if option.selected_value == value %} is-active{% endif %}" data-variant-option-value="{{ value }}">
                      {{ value }}
                    </span>
                  {% endfor %}
                </div>
              {% endif %}

              Be sure to hide the corresponding select tag for that option
            {% endcomment %}

          {% endfor %}
        {% endunless %}

        <select name="id" class="no-js" data-product-select>
          {% for variant in product.variants %}
            <option
              {% if variant == current_variant %}selected="selected"{% endif %}
              {% unless variant.available %}disabled="disabled"{% endunless %}
              value="{{ variant.id }}">
                {{ variant.title }}
            </option>
          {% endfor %}
        </select>

        <div class="selector-wrapper form-group" style="display: none;">
          <label for="Quantity">{{ 'products.product.quantity' | t }}:</label>
          <div style="max-width: 80px;">
            <select id="Quantity" name="quantity" class="form-control" {% if current_variant.available == false %}disabled="true"{% endif %} data-product-quantity-select>
              {% for i in (1..5) %}
                <option value="{{ i }}">{{ i }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        {% assign product_disable_bis = product.metafields.custom_fields['bis_disable'] | default: 0 %}
        {% assign variant_disable_bis = current_variant.metafields.custom_fields['bis_disable'] | default: 0 %}
        {% if product_disable_bis == 1 or variant_disable_bis == 1 %}
          {% assign disable_bis_button = true %}
        {% else %}
          {% assign disable_bis_button = false %}
        {% endif %}
        <button
          type="submit"
          name="add"
          class="btn btn-primary btn-block product__add-to-cart"
          data-add-to-cart
          {% unless current_variant.available %}
            {% unless disable_bis_button == true %}
              style="display: none;"
            {% endunless %}
          {% endunless %}
          {% unless current_variant.available %}disabled="disabled"{% endunless %}>
            <span data-add-to-cart-text>
              {% if current_variant.available %}
                {{ 'products.product.add_to_cart' | t }}
              {% else %}
                {{ 'products.product.sold_out' | t }}
              {% endif %}
            </span>
            - <span data-add-to-cart-price>{{ current_variant.price | money_without_trailing_zeros }}</span>
        </button>
        <button
          type="button"
          name="bis-button"
          class="btn btn--small btn-outline-primary btn-back-in-stock"
          data-bis-toggler
          data-bis-button
          {% if current_variant.available or disable_bis_button == true %}
            style="display:none;"
          {% endif %}>
          {% include 'icon-bell' %}
          Notify me when back
        </button>
      </form>

      {% if settings.shipping_cta_title != blank and shipping_modal_html != blank%}
        <a href="javascript:void(0);" class="btn-link product__shipping-toggler" data-shipping-modal-trigger>{{ settings.shipping_cta_title }}</a>
      {% endif %}
    </div>
  </div>

  {% comment %}Leaving RTE Here because the designs doesn't show it but it might be required.{% endcomment %}
 {% comment %} <div class="rte">
    {{ product.description }}
  </div>{% endcomment %}


  {% if is_quick_view %}
    {% comment %} This link will get updated on variant change.  See productDetailForm.js {% endcomment %}
    <a href="{{ current_variant.url }}" data-full-details-link>View Full Details</a>
  {% endif %}

  {% unless product == empty %}
    <script type="application/json" data-product-json>
    {% include 'product-json', product: product %}
    </script>

    {% assign product_default_badge = product.metafields.custom_fields['badge'] %}

    {% unless product.available %}
      {% assign product_default_badge = 'Sold Out' %}
    {% endunless %}

    {% if product_default_badge == blank %}
      {% for tag in product.tags %}
        {% if tag contains 'Badge:' or tag contains 'badge:'%}
          {% assign product_default_badge = tag | remove: 'Badge:' | remove: 'badge:' %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
    <script type="application/json" data-badges-json>
      {
        "default": {{ product_default_badge | json }},
      {% for variant in product.variants %}
        "{{ variant.id }}": {{ variant.metafields.custom_fields['badge'] | json }} {% unless forloop.last %} ,{% endunless %}
      {% endfor %}
      }
    </script>
  {% endunless %}
</div>
