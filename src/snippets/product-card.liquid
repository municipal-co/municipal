{%- comment %}

  Product Card
  ------------------------------------------------------------------------------

  Usage:

  {% include 'product-card',
        card_product: { product } - required
        variant: { product.variant } - optional - if not blank, product card will render an individual variant's data
        unavailable_variant: { product.variant } - optional - overrides the featured image to display the sold out featured image
        quick_view: { boolean } - optional, defaults to false
        show_swatches: { boolean } - optional, defaults to true
        show_reviews: { boolean } - optional, defaults to false
        show_sizes: { boolean } - optional, defaults to false
        show_colors: { boolean } - optional, defaults to false
        show_tag: { bool } - optional, defaults to false
        color: { string } - optional
        title_tag: { string } - optional - defaults to 'h3'
  %}

{% endcomment -%}

{% comment %} Defaults {% endcomment %}
{% assign image_loading_placeholder = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" %}

{% assign card_classes = blank %}

{% if quick_view == blank %}
  {% assign quick_view = false %}
{% endif %}

{% if render_json == blank %}
  {% assign render_json = true %}
{% endif %}

{% if lazy_load_img == blank %}
  {% assign lazy_load_img = true %}
{% endif %}

{% if show_swatches == blank %}
  {% assign show_swatches = true %}
{% endif %}

{% if show_sizes == blank %}
  {% assign show_sizes = false %}
{% endif %}

{% if show_reviews == blank %}
  {% assign show_reviews = false %}
{% endif %}

{% if title_tag == blank %}
  {% assign title_tag = 'h3' %}
{% endif %}

{% if reverse_card == true %}
  {% assign card_classes = "card--reverse" %}
{% endif %}

{% if cart_product.metafields.custom-fields.hide_colors %}
  {% assign hidden_colors_list = cart_product.metafields.custom-fields.hide_colors | split: ',' %}
  {% assign hidden_colors_count = hidden_colors_list | size %}
{% endif %}

{%- comment -%}
Locate Current Available color and its array position
{%- endcomment -%}
{% for option in card_product.options_with_value %}
  {% if option.name == 'color' or option.name == 'Color' %}
    {% assign color_index = forloop.index %}
  {% endif %}

  {% assign product_current_variant = card_product.first_available_variant %}
  {% assign product_current_color = current_color | default: product_curent_variant.options[color_index] %}
{% endfor %}

{% comment %} End Defaults {% endcomment %}

{% assign alt_swatch_identifier = 'swatch' %} {% comment %} Used to find swatch images attached at the product level.  We don't want to display them in the gallery. {% endcomment %}

{% assign featured_image = card_product.selected_or_first_available_variant.image | default: card_product.featured_image %}
{% if variant != blank %}
  {% assign featured_image = variant.featured_image %}
{% endif %}

{% comment %} This will override the featured image to display the sold out featured image {% endcomment %}
{% if unavailable_variant != blank %}
  {% assign featured_image = unavailable_variant.featured_image %}
{% endif %}

{% if card_product %}

  {% assign product_image_dimension = '760x' %}
  {% assign product_image_dimension_tablet = '400x' %}
  {% assign product_image_dimension_mobile = '150x' %}
  {% assign product_url = variant.url | default: unavailable_variant.url | default: card_product.url | within: collection %}

  <div id="product-card-{{ card_product.id }}" class="product-card {{ card_classes }}" data-product-card
  {% unless auto_update_image == false and variant == blank %}
    data-product-merged
  {% endunless %}
  >
    <div class="product-card__contents" data-product-card-contents>
      <div class="product-card__gallery">
        <a href="{{ product_url }}">
          <div class="product-card__gallery-image" data-product-card-gallery>
            <img src="{{ image_loading_placeholder }}" data-src="{{featured_image | img_url: product_image_dimension }}"
            data-srcset="
            {{featured_image | img_url: product_image_dimension_mobile }},
            {{featured_image | img_url: product_image_dimension_tablet }} 768w,
            {{featured_image | img_url: product_image_dimension }} 992w"
            alt="{{ featured_image.alt }}"
            class="animate"
            data-animate-image-in
            data-sizes="auto"
            data-object-fit="cover"
            data-product-card-image
            {% if lazy_load_img %} data-product-card-main-lazy {% endif %}>
            <div class="product-card__gallery-placeholder"></div>
          </div>

          {% if show_sizes %}
            {%- capture sizes_html -%}
            {% render 'product-dots-sizes'
                        dots_product: card_product,
                        current_color: product_current_color %}
            {%- endcapture -%}

            {% if sizes_html != blank %}
              <div class="product-card__sizes-container">
                <div class="variant-message" data-variant-message>
                  Quick Add to Cart
                </div>
                {{ sizes_html }}
              </div>
            {% endif %}
          {% endif %}
        </a>
      </div>
      <div class="product-card__info">

        {% if show_tag %}
          {% capture tag_html %}
            {% if card_product != blank %}
              {% if variant.metafields.custom_fields['badge'] != blank %}
                <span class="badge">{{ variant.metafields.custom_fields['badge'] }}</span>
              {% elsif unavailable_variant.metafields.custom_fields['badge'] != blank %}
                <span class="badge">{{ unavailable_variant.metafields.custom_fields['badge'] }}</span>
              {% elsif card_product.metafields.custom_fields['badge'] %}
                <span class="badge">{{ card_product.metafields.custom_fields['badge'] }}</span>
              {% else %}
                {% for tag in card_product.tags %}
                  {% if tag contains 'Badge:' or tag contains 'badge:' %}
                    <span class="badge">{{ tag | remove: 'Badge:' | remove: 'badge:' }}</span>
                    {% break %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endcapture %}

          <div class="product-card__badge-row">
            {% if tag_html != blank %}
              {{ tag_html }}
              {% else %}
              <span class="badge" aria-hidden style="visibility: hidden;">-</span>
            {% endif %}
          </div>
        {% endif %}

        <{{title_tag}} class="product-card__info-title">
          <a href="{{ product_url }}">{{ card_product.title }}</a>
        </{{title_tag}}>

        {% if show_colors %}
          {% capture color_html %}
            {% include 'product-colors-counter', product: card_product, current_color: product_current_color, hidden_colors: hidden_colors_count %}
          {% endcapture %}

          {% if color_html != blank %}
            <div class="product-card__info-color">
              {{ color_html }}
            </div>
          {% endif %}
        {% endif %}

        <div class="product-card__info-price">
          {% if variant != blank %}
            {% if variant.compare_at_price > variant.price %}
              <s>{{ variant.compare_at_price | money }}</s>
              <span class="visually-hidden">{{ 'products.product.regular_price' | t }}</span>
            {% endif %}

            {{ variant.price | money }}
          {% else %}
            {% if card_product.compare_at_price > card_product.price %}
              <s>{{ card_product.compare_at_price | money }}</s>
              <span class="visually-hidden">{{ 'products.product.regular_price' | t }}</span>
            {% endif %}

            {% if card_product.price_varies %}
              {%- assign price = card_product.price | money -%}
              {{ 'products.product.from_text_html' | t: price: price }}
            {% else %}
              {{ card_product.price | money }}
            {% endif %}
          {% endif %}

        </div>

        {% if show_reviews %}
          {% comment %} Add your review provider markup here {% endcomment %}
        {% endif %}

      </div>
    </div>

    {% if render_json == true %}
      <script type="application/json" data-product-json>
        {% include 'product-json' %}
      </script>
    {% endif %}

  </div>

{% endif %}
